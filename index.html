<!DOCTYPE html>
<html lang="ru">
<head>
  <!-- Yandex.Metrika counter -->
  <script type="text/javascript">
    (function(m,e,t,r,i,k,a){
        m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
        m[i].l=1*new Date();
        for (var j = 0; j < document.scripts.length; j++) {if (document.scripts[j].src === r) { return; }}
        k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)
    })(window, document,'script','https://mc.yandex.ru/metrika/tag.js?id=106208328', 'ym');

    ym(106208328, 'init', {ssr:true, webvisor:true, clickmap:true, ecommerce:"dataLayer", accurateTrackBounce:true, trackLinks:true});
  </script>
  <noscript><div><img src="https://mc.yandex.ru/watch/106208328" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
  <!-- /Yandex.Metrika counter -->

<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0" />
<title>–ú–∞–ª–æ–†–∏—Å–∞ ‚Äî –ó–º–µ–π–∫–∞</title>

<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">

<style>
:root{
  /* Dark theme */
  --bg0:#07070c;
  --bg1:#10101a;

  --panel: rgba(18,18,26,0.70);
  --panel-border: rgba(255,255,255,0.10);

  --canvas:#07070c;
  --text:#f5f5ff;
  --muted: rgba(245,245,255,0.72);

  --accent:#ff6b9a;
  --accent2:#8be9ff;

  --grid: rgba(255,255,255,0.06);

  --btn-face: rgba(255,255,255,0.10);
  --btn-face2: rgba(255,255,255,0.06);
  --btn-shadow: rgba(0,0,0,0.60);

  --shadow-lg: 0 18px 60px rgba(0,0,0,0.55);
  --shadow-md: 0 12px 30px rgba(0,0,0,0.35);
  --shadow-in: inset 0 1px 0 rgba(255,255,255,0.14), inset 0 -2px 0 rgba(0,0,0,0.28);

  --radius-xl: 22px;
  --radius-lg: 18px;
  --radius-md: 14px;
}
body.light{
  /* Light theme */
  --bg0:#f6f6fb;
  --bg1:#ececf5;

  --panel: rgba(255,255,255,0.80);
  --panel-border: rgba(0,0,0,0.08);

  --canvas:#f1f1f8;
  --text:#11111a;
  --muted: rgba(17,17,26,0.68);

  --grid: rgba(0,0,0,0.07);

  --btn-face: rgba(0,0,0,0.06);
  --btn-face2: rgba(0,0,0,0.04);
  --btn-shadow: rgba(0,0,0,0.18);

  --shadow-lg: 0 18px 60px rgba(0,0,0,0.14);
  --shadow-md: 0 12px 30px rgba(0,0,0,0.10);
  --shadow-in: inset 0 1px 0 rgba(255,255,255,0.55), inset 0 -2px 0 rgba(0,0,0,0.08);
}

*{margin:0;padding:0;box-sizing:border-box}
html, body { height: 100%; }

body{
  background:
    radial-gradient(1200px 700px at 20% 10%, rgba(255,107,154,0.18), transparent 60%),
    radial-gradient(900px 500px at 80% 20%, rgba(139,233,255,0.12), transparent 55%),
    linear-gradient(180deg, var(--bg0), var(--bg1));
  color:var(--text);
  font-family:system-ui,sans-serif;
  display:flex;
  flex-direction:column;
  align-items:center;
  min-height:100vh;
  touch-action:none;
  overflow:hidden;
}

/* subtle grain */
body::before{
  content:"";
  position:fixed;
  inset:-20px;
  pointer-events:none;
  opacity:0.08;
  mix-blend-mode: overlay;
  background-image:
    url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='180' height='180'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='2' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='180' height='180' filter='url(%23n)' opacity='0.75'/%3E%3C/svg%3E");
  transform: translateZ(0);
}

header{
  width:min(980px, 100%);
  padding:12px 14px;
  margin-top: 10px;
  border-radius: 16px;
  background: var(--panel);
  backdrop-filter: blur(14px);
  -webkit-backdrop-filter: blur(14px);
  border: 1px solid var(--panel-border);
  box-shadow: var(--shadow-md);
  display:flex;
  justify-content:space-between;
  align-items:center;
}

.title{
  font-family:'Press Start 2P', monospace;
  font-size:14px;
  letter-spacing: 0.5px;
  color:var(--accent);
  text-shadow: 0 0 18px rgba(255,107,154,0.35);
}

.pill{
  display:flex;
  gap:10px;
  align-items:center;
  color: var(--muted);
  font-size: 14px;
}
.pill b{ color: var(--text); }

.btn-ui{
  padding:7px 10px;
  border-radius: 12px;
  background: rgba(255,255,255,0.08);
  border: 1px solid rgba(255,255,255,0.12);
  box-shadow: var(--shadow-in);
  user-select:none;
  transition: transform .08s, filter .08s;
}
.btn-ui:active{ transform: translateY(2px); filter: brightness(1.05); }
body.light .btn-ui{
  background: rgba(0,0,0,0.05);
  border-color: rgba(0,0,0,0.08);
}

#game{
  background:
    radial-gradient(900px 600px at 50% 15%, rgba(255,255,255,0.03), transparent 55%),
    linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.06)),
    var(--canvas);
  border-radius: var(--radius-lg);
  margin: 12px 0 6px 0;
  image-rendering: pixelated;
  box-shadow: var(--shadow-lg);
  border: 1px solid rgba(255,255,255,0.10);
  width: min(92vw, 440px);
  height: auto;
  aspect-ratio: 1 / 1;
}

/* Controls */
.controls{
  margin-top: 24px;
  display:grid;
  grid-template-columns:repeat(3,74px);
  grid-template-rows:repeat(2,74px);
  gap: 18px;
  position:relative;
  padding: 14px;
  border-radius: 28px;
  background: rgba(255,255,255,0.03);
  border: 1px solid rgba(255,255,255,0.08);
  box-shadow: var(--shadow-md);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
}

.btn{
  background:
    radial-gradient(120px 80px at 30% 25%, rgba(255,255,255,0.18), transparent 60%),
    linear-gradient(180deg, var(--btn-face), var(--btn-face2));
  border-radius: 16px;
  display:flex;
  justify-content:center;
  align-items:center;
  font-size: 26px;
  color: rgba(255,255,255,0.92);
  user-select:none;
  box-shadow:
    var(--shadow-in),
    0 12px 0 var(--btn-shadow),
    0 18px 30px rgba(0,0,0,0.25);
  border: 1px solid rgba(255,255,255,0.10);
  transition: transform .07s, box-shadow .07s, filter .07s;
}
body.light .btn{ color: rgba(0,0,0,0.78); }

.btn:active{
  transform: translateY(6px);
  box-shadow:
    var(--shadow-in),
    0 6px 0 var(--btn-shadow),
    0 10px 22px rgba(0,0,0,0.20);
  filter: brightness(1.05);
}

.up{grid-column:2}
.left{grid-column:1}
.down{grid-column:2}
.right{grid-column:3}

/* Overlays (–¥–æ—Ä–æ–∂–µ + –ø–ª–∞–≤–Ω–æ) */
.overlay{
  position:fixed;
  inset:0;
  display:flex;
  flex-direction:column;
  justify-content:center;
  align-items:center;
  z-index:10;
  padding: 22px;

  background:
    radial-gradient(1200px 700px at 20% 10%, rgba(255,107,154,0.16), transparent 60%),
    radial-gradient(900px 500px at 80% 20%, rgba(139,233,255,0.12), transparent 55%),
    rgba(0,0,0,0.25);
  backdrop-filter: blur(16px);
  -webkit-backdrop-filter: blur(16px);

  opacity: 0;
  transform: scale(1.03);
  pointer-events:none;
  transition: opacity .18s ease, transform .18s ease;
}
.overlay.show{
  opacity: 1;
  transform: scale(1);
  pointer-events:auto;
}

.card{
  width: min(440px, 92vw);
  border-radius: var(--radius-xl);
  background: var(--panel);
  border: 1px solid var(--panel-border);
  box-shadow: var(--shadow-lg);
  padding: 18px;
}

.logo{
  font-family:'Press Start 2P', monospace;
  font-size:24px;
  color:var(--accent);
  margin-bottom:14px;
  text-shadow: 0 0 26px rgba(255,107,154,0.35);
  animation: float 2.5s ease-in-out infinite;
}
@keyframes float{
  0%{transform:translateY(0)}
  50%{transform:translateY(-10px)}
  100%{transform:translateY(0)}
}

.pixel-btn{
  font-family:'Press Start 2P', monospace;
  padding:16px 18px;
  border-radius: var(--radius-lg);
  background: linear-gradient(180deg, rgba(255,107,154,1), rgba(255,107,154,0.86));
  color:#0b0b10;
  margin-top:12px;
  user-select:none;
  text-align:center;
  width: 100%;
  box-shadow: 0 14px 34px rgba(255,107,154,0.20);
  border: 1px solid rgba(255,255,255,0.15);
  transition: transform .08s, filter .08s;
}
.pixel-btn:active{ transform: translateY(2px); filter: brightness(1.03); }

.pixel-btn.secondary{
  background: rgba(255,255,255,0.06);
  color:var(--accent);
  border: 1px solid rgba(255,107,154,0.35);
  box-shadow: none;
}

.small{
  font-size:12px;
  margin-top:10px;
  color: var(--muted);
}
#toast{ opacity:0; transition:opacity .2s; }

/* Nick */
.nick-wrap{
  width:100%;
  background: rgba(255,255,255,0.05);
  border-radius: var(--radius-lg);
  padding: 14px;
  box-shadow: var(--shadow-in);
  border: 1px solid rgba(255,255,255,0.10);
  margin-top: 10px;
}
.nick-label{
  font-family:'Press Start 2P', monospace;
  font-size: 10px;
  opacity:.92;
  margin-bottom: 10px;
  color: rgba(255,255,255,0.88);
}
body.light .nick-label{ color: rgba(0,0,0,0.72); }

.nick-row{ display:flex; gap:10px; }
.nick-input{
  flex:1;
  padding: 12px 12px;
  border-radius: 12px;
  border: 1px solid rgba(255,255,255,0.14);
  background: rgba(0,0,0,0.12);
  color: var(--text);
  font-size: 14px;
  outline: none;
}
body.light .nick-input{
  background: rgba(255,255,255,0.65);
  border-color: rgba(0,0,0,0.10);
}

.nick-save{
  font-family:'Press Start 2P', monospace;
  padding: 12px 12px;
  border-radius: 12px;
  border: 1px solid rgba(255,107,154,0.55);
  background: rgba(255,107,154,0.08);
  color: var(--accent);
  user-select:none;
  white-space:nowrap;
  transition: transform .08s, filter .08s;
}
.nick-save:active{ transform: translateY(2px); filter: brightness(1.03); }

.nick-hint{ margin-top:10px; font-size:12px; color: var(--muted); }
.nick-status{ margin-top:8px; font-size: 12px; min-height: 16px; }
.nick-status.ok{ color: #6dffb0; }
.nick-status.err{ color: #ff7b9e; }

.lb-wrap{
  margin-top: 14px;
  padding: 12px;
  border-radius: var(--radius-lg);
  background: rgba(255,255,255,0.04);
  border: 1px solid rgba(255,255,255,0.10);
  box-shadow: var(--shadow-in);
}
</style>
</head>

<body>

<!-- MAIN MENU -->
<div class="overlay show" id="start" style="display:flex">
  <div class="card">
    <div class="logo">–ú–ê–õ–û–†–ò–°–ê</div>

    <!-- –ù–∏–∫ -->
    <div class="nick-wrap">
      <div class="nick-label">–ù–ò–ö (–£–ù–ò–ö–ê–õ–¨–ù–´–ô)</div>
      <div class="nick-row">
        <input id="nick" class="nick-input" maxlength="24" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: malorisa_fox" />
        <div class="nick-save" id="saveNick">OK</div>
      </div>
      <div class="nick-hint">1‚Äì24 —Å–∏–º–≤–æ–ª–∞. –ù–∏–∫–∏ —É–Ω–∏–∫–∞–ª—å–Ω—ã –¥–ª—è –≤—Å–µ—Ö –∏–≥—Ä–æ–∫–æ–≤.</div>
      <div class="nick-status" id="nickStatus"></div>
    </div>

    <div class="pixel-btn" id="play">–ò–ì–†–ê–¢–¨</div>
    <div class="pixel-btn secondary" id="invite">–ü–†–ò–ì–õ–ê–°–ò–¢–¨ –î–†–£–ì–ê</div>
    <div class="pixel-btn secondary" id="site">–ü–ï–†–ï–ô–¢–ò –ù–ê –°–ê–ô–¢</div>

    <div class="small" id="toast"></div>
  </div>
</div>

<!-- PAUSE MENU -->
<div class="overlay" id="pauseMenu" style="display:none">
  <div class="card">
    <div class="logo" style="animation:none">–ü–ê–£–ó–ê</div>
    <div class="pixel-btn" id="resume">–ü–†–û–î–û–õ–ñ–ò–¢–¨</div>
    <div class="pixel-btn secondary" id="toMenu">–í –ì–õ–ê–í–ù–û–ï –ú–ï–ù–Æ</div>
  </div>
</div>

<!-- GAME OVER -->
<div class="overlay" id="over" style="display:none">
  <div class="card">
    <div class="logo" style="animation:none">GAME OVER</div>
    <div class="small" style="opacity:1">
      –°—á–µ—Ç: <b><span id="finalScore">0</span></b> |
      –†–µ–∫–æ—Ä–¥: <b><span id="finalRecord">0</span></b>
    </div>

    <div class="pixel-btn" id="restart">–°–ù–û–í–ê</div>
    <div class="pixel-btn secondary" id="menuFromOver">–í –ì–õ–ê–í–ù–û–ï –ú–ï–ù–Æ</div>

    <div class="lb-wrap small" style="margin-top:14px;opacity:1;max-width:360px;text-align:left">
      <div style="margin-bottom:8px;">üèÜ –¢–æ–ø –∏–≥—Ä–æ–∫–æ–≤:</div>
      <div id="leaderboard" style="line-height:1.6"></div>
    </div>
  </div>
</div>

<header>
  <span class="pill">–°—á–µ—Ç: <b id="score">0</b></span>
  <span class="title">–ú–ê–õ–û–†–ò–°–ê</span>
  <span class="pill" style="gap:8px;">
    <span>–†–µ–∫–æ—Ä–¥: <b id="record">0</b></span>
    <span class="btn-ui" id="sound" title="–ó–≤—É–∫">üîä</span>
    <span class="btn-ui" id="pause" title="–ü–∞—É–∑–∞">‚è∏</span>
    <span class="btn-ui" id="theme" title="–¢–µ–º–∞">‚òÄÔ∏é / üåô</span>
  </span>
</header>

<canvas id="game" width="320" height="320"></canvas>

<div class="controls">
  <div></div><div class="btn up">‚ñ≤</div><div></div>
  <div class="btn left">‚óÄ</div><div class="btn down">‚ñº</div><div class="btn right">‚ñ∂</div>
</div>

<script type="module">
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

(() => {
  const $ = (id) => document.getElementById(id);

  // Supabase
  const SUPABASE_URL = "https://xymyjykcispbuqexfgop.supabase.co";
  const SUPABASE_PUBLISHABLE_KEY = "sb_publishable_vAQ-xCwv77sxrskSyrHPmg_DzoqHyi6";
  const supabase = createClient(SUPABASE_URL, SUPABASE_PUBLISHABLE_KEY);

  // DOM
  const canvas = $("game");
  const ctx = canvas.getContext("2d");
  ctx.imageSmoothingEnabled = false;

  const UI = {
    start: $("start"),
    pauseMenu: $("pauseMenu"),
    over: $("over"),

    play: $("play"),
    invite: $("invite"),
    site: $("site"),
    toast: $("toast"),

    resume: $("resume"),
    toMenu: $("toMenu"),

    restart: $("restart"),
    menuFromOver: $("menuFromOver"),

    score: $("score"),
    record: $("record"),
    finalScore: $("finalScore"),
    finalRecord: $("finalRecord"),

    pause: $("pause"),
    theme: $("theme"),
    sound: $("sound"),

    leaderboard: $("leaderboard"),

    nick: $("nick"),
    saveNick: $("saveNick"),
    nickStatus: $("nickStatus"),
  };

  // Constants
  const BOX = 20;
  const COLS = canvas.width / BOX;
  const ROWS = canvas.height / BOX;
  const TICK_MS = 150;
  const FOODS = ["üç£","üçü","üçî","üçï"];

  // Persistent settings
  let record = Number(localStorage.getItem("malorisa_record") || 0);
  let soundOn = localStorage.getItem("malorisa_sound") !== "0";

  UI.record.textContent = record;
  UI.finalRecord.textContent = record;
  UI.sound.textContent = soundOn ? "üîä" : "üîá";

  const showToast = (text) => {
    UI.toast.textContent = text;
    UI.toast.style.opacity = "1";
    clearTimeout(showToast._t);
    showToast._t = setTimeout(() => UI.toast.style.opacity = "0", 1400);
  };

  const setNickStatus = (text, kind = "") => {
    UI.nickStatus.textContent = text || "";
    UI.nickStatus.className = "nick-status " + (kind || "");
  };

  const normalizeNick = (s) => (s || "")
    .trim()
    .replace(/\s+/g, "_")
    .slice(0, 24);

  const getSavedPlayer = () => {
    const player_id = localStorage.getItem("malorisa_player_id") || "";
    const name = localStorage.getItem("malorisa_name") || "";
    return { player_id, name };
  };

  const setSavedPlayer = ({ player_id, name }) => {
    localStorage.setItem("malorisa_player_id", player_id);
    localStorage.setItem("malorisa_name", name);
  };

  const ensureNickRegisteredUI = () => {
    const { player_id, name } = getSavedPlayer();
    if (name) UI.nick.value = name;
    if (player_id && name) setNickStatus(`‚úÖ –ù–∏–∫ –∑–∞–∫—Ä–µ–ø–ª—ë–Ω: ${name}`, "ok");
    else setNickStatus("–í–≤–µ–¥–∏ –Ω–∏–∫ –∏ –Ω–∞–∂–º–∏ OK", "");
  };

  // Overlay helpers (–ø–ª–∞–≤–Ω–µ–µ)
  const showOverlay = (el) => {
    el.style.display = "flex";
    requestAnimationFrame(() => el.classList.add("show"));
  };
  const hideOverlay = (el) => {
    el.classList.remove("show");
    setTimeout(() => { el.style.display = "none"; }, 190);
  };
  const hideAllOverlays = () => {
    hideOverlay(UI.start);
    hideOverlay(UI.pauseMenu);
    hideOverlay(UI.over);
  };

  // Register nick in malorisa_players
  const registerNick = async () => {
    const raw = UI.nick.value;
    const name = normalizeNick(raw);

    if (!name || name.length < 1 || name.length > 24) {
      setNickStatus("–ù–∏–∫ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å 1‚Äì24 —Å–∏–º–≤–æ–ª–∞", "err");
      return false;
    }

    setNickStatus("‚è≥ –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∏–∫...", "");

    try {
      const { data, error } = await supabase
        .from("malorisa_players")
        .insert({ name })
        .select("id,name")
        .single();

      if (error) {
        const msg = (error?.message || "").toLowerCase();
        if (msg.includes("duplicate") || msg.includes("unique") || msg.includes("23505")) {
          setNickStatus("‚ùå –ù–∏–∫ —É–∂–µ –∑–∞–Ω—è—Ç. –í—ã–±–µ—Ä–∏ –¥—Ä—É–≥–æ–π.", "err");
          return false;
        }
        console.warn("registerNick error:", error);
        setNickStatus("‚ùå –û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –Ω–∏–∫–∞", "err");
        return false;
      }

      setSavedPlayer({ player_id: data.id, name: data.name });
      setNickStatus(`‚úÖ –ù–∏–∫ –∑–∞–∫—Ä–µ–ø–ª—ë–Ω: ${data.name}`, "ok");
      showToast("–ù–∏–∫ —Å–æ—Ö—Ä–∞–Ω—ë–Ω ‚úÖ");
      return true;
    } catch (e) {
      console.warn("registerNick exception:", e);
      setNickStatus("‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏/—Å–µ—Ä–≤–µ—Ä–∞", "err");
      return false;
    }
  };

  // Leaderboard
  const renderLeaderboard = (rows) => {
    if (!UI.leaderboard) return;
    if (!rows?.length) {
      UI.leaderboard.textContent = "–ü–æ–∫–∞ –ø—É—Å—Ç–æ ‚Äî –±—É–¥—å –ø–µ—Ä–≤—ã–º üôÇ";
      return;
    }
    UI.leaderboard.innerHTML = rows.map((r, i) => {
      const safeName = String(r.name).replace(/[<>&"]/g, (c) => ({
        "<":"&lt;", ">":"&gt;", "&":"&amp;", '"':"&quot;"
      }[c]));
      const medal = i === 0 ? "ü•á " : (i === 1 ? "ü•à " : (i === 2 ? "ü•â " : ""));
      return `${medal}${i+1}. ${safeName} ‚Äî <b>${r.best_score}</b>`;
    }).join("<br>");
  };

  const loadLeaderboard = async () => {
    try {
      const { data, error } = await supabase
        .from("malorisa_leaderboard")
        .select("name, best_score, first_best_time")
        .order("best_score", { ascending: false })
        .order("first_best_time", { ascending: true })
        .limit(10);

      if (error) throw error;
      renderLeaderboard(data);
    } catch (e) {
      console.warn("Leaderboard load error:", e);
      if (UI.leaderboard) UI.leaderboard.textContent = "–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ç–æ–ø üòï";
    }
  };

  const submitScore = async (score) => {
    const { player_id, name } = getSavedPlayer();
    if (!player_id || !name) return;

    try {
      const { error } = await supabase
        .from("malorisa_scores")
        .insert({ player_id, name, score });

      if (error) throw error;
    } catch (e) {
      console.warn("Score submit error:", e);
    }
  };

  // Share
  const shareGame = async () => {
    const text = "–ü–æ–ø—Ä–æ–±—É–π –ø–æ–±–∏—Ç—å –º–æ–π —Ä–µ–∫–æ—Ä–¥ –≤ –∑–º–µ–π–∫–µ –æ—Ç –ú–∞–ª–æ–†–∏—Å–∞";
    const url = location.href;

    if (navigator.share) {
      try { await navigator.share({ title: "–ú–∞–ª–æ–†–∏—Å–∞ ‚Äî –ó–º–µ–π–∫–∞", text, url }); return; } catch {}
    }

    const fallback = `${text}\n${url}`;
    try { await navigator.clipboard.writeText(fallback); showToast("–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞ ‚úÖ"); }
    catch { window.prompt("–°–∫–æ–ø–∏—Ä—É–π –∏ –æ—Ç–ø—Ä–∞–≤—å –¥—Ä—É–≥—É:", fallback); }
  };

  // Audio
  let audioCtx = null;
  const initAudio = async () => {
    if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    if (audioCtx.state === "suspended") { try { await audioCtx.resume(); } catch {} }
  };
  const beep = (freq, dur = 0.1) => {
    if (!soundOn || !audioCtx) return;
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    o.type = "square";
    o.frequency.setValueAtTime(freq, audioCtx.currentTime);
    g.gain.setValueAtTime(0.085, audioCtx.currentTime);
    o.connect(g).connect(audioCtx.destination);
    o.start();
    o.stop(audioCtx.currentTime + dur);
  };
  const vibrate = (ms = 20) => { if (navigator.vibrate) navigator.vibrate(ms); };

  // State
  const State = {
    mode: "start",
    snake: [],
    dir: { x: 1, y: 0 },
    food: { x: 5, y: 5, icon: "üç£" },
    score: 0,
    pop: null,
    chomp: null,  // {t, dur}
    death: null,
    foodWobbleT: 0,
  };

  const cellToPx = (c) => c * BOX;
  const now = () => performance.now();

  const goToMenu = () => {
    State.mode = "start";
    hideAllOverlays();
    showOverlay(UI.start);
    UI.pause.textContent = "‚è∏";
  };

  const spawnFood = () => {
    let f;
    do {
      f = {
        x: Math.floor(Math.random() * COLS),
        y: Math.floor(Math.random() * ROWS),
        icon: FOODS[Math.floor(Math.random() * FOODS.length)],
      };
    } while (State.snake.some(p => p.x === f.x && p.y === f.y));
    State.food = f;
    State.foodWobbleT = now();
  };

  const startGame = () => {
    State.snake = [{ x: 10, y: 10 }];
    State.dir = { x: 1, y: 0 };
    State.score = 0;
    State.mode = "playing";
    State.pop = null;
    State.chomp = null;
    State.death = null;

    UI.score.textContent = "0";
    UI.pause.textContent = "‚è∏";
    spawnFood();
  };

  const endGame = async () => {
    State.mode = "gameover";

    if (State.score > record) {
      record = State.score;
      localStorage.setItem("malorisa_record", String(record));
    }

    UI.record.textContent = record;
    UI.finalRecord.textContent = record;
    UI.finalScore.textContent = State.score;

    hideAllOverlays();
    showOverlay(UI.over);

    await submitScore(State.score);
    await loadLeaderboard();
  };

  const beginDeathAnimation = () => {
    const particles = [];
    const parts = State.snake;

    for (const seg of parts) {
      const baseX = cellToPx(seg.x) + 1;
      const baseY = cellToPx(seg.y) + 1;
      const w = BOX - 2;

      const offsets = [
        { ox: 2, oy: 2 },
        { ox: w - 6, oy: 2 },
        { ox: 2, oy: w - 6 },
        { ox: w - 6, oy: w - 6 },
      ];

      for (const o of offsets) {
        const px = baseX + o.ox;
        const py = baseY + o.oy;
        particles.push({
          x: px,
          y: py,
          vx: (Math.random() - 0.5) * 0.9,
          vy: 0.35 + Math.random() * 1.25,
          size: 4,
          life: 1,
        });
      }
    }

    State.mode = "dying";
    State.death = { t: now(), dur: 460, particles };
    beep(140, 0.18);
    vibrate(30);
  };

  const setDir = (x, y) => {
    if (State.mode === "dying" || State.mode === "start" || State.mode === "gameover") return;
    if (State.dir.x === -x && State.dir.y === -y) return;
    State.dir = { x, y };
  };

  const openPauseMenu = () => {
    if (State.mode === "dying" || State.mode === "start" || State.mode === "gameover") return;
    State.mode = "paused";
    hideAllOverlays();
    showOverlay(UI.pauseMenu);
    UI.pause.textContent = "‚ñ∂";
    beep(520, 0.08);
  };

  const resumeGame = () => {
    if (State.mode !== "paused") return;
    State.mode = "playing";
    hideAllOverlays();
    UI.pause.textContent = "‚è∏";
    beep(520, 0.08);
  };

  // Game tick
  const tick = () => {
    if (State.mode !== "playing") return;

    const head = State.snake[0];
    const nx = (head.x + State.dir.x + COLS) % COLS;
    const ny = (head.y + State.dir.y + ROWS) % ROWS;
    const newHead = { x: nx, y: ny };

    if (State.snake.some(p => p.x === newHead.x && p.y === newHead.y)) {
      beginDeathAnimation();
      return;
    }

    State.snake.unshift(newHead);

    if (newHead.x === State.food.x && newHead.y === State.food.y) {
      State.score++;
      UI.score.textContent = String(State.score);

      const t = now();
      State.pop = { x: State.food.x, y: State.food.y, t, dur: 240 };
      State.chomp = { t, dur: 190 };

      beep(880, 0.09);
      vibrate(18);
      spawnFood();
    } else {
      State.snake.pop();
    }
  };

  // Rendering helpers
  const drawGrid = () => {
    const grid = getComputedStyle(document.body).getPropertyValue("--grid").trim();
    ctx.strokeStyle = grid;
    ctx.lineWidth = 1;

    for (let i = 0; i <= COLS; i++) {
      const x = i * BOX + 0.5;
      ctx.beginPath();
      ctx.moveTo(x, 0);
      ctx.lineTo(x, canvas.height);
      ctx.stroke();
    }
    for (let i = 0; i <= ROWS; i++) {
      const y = i * BOX + 0.5;
      ctx.beginPath();
      ctx.moveTo(0, y);
      ctx.lineTo(canvas.width, y);
      ctx.stroke();
    }
  };

  const drawFood = (t) => {
    // –ª—ë–≥–∫–∞—è "–¥–æ—Ä–æ–≥–∞—è" –∞–Ω–∏–º–∞—Ü–∏—è: –ø–æ–∫–∞—á–∏–≤–∞–Ω–∏–µ/–ø—É–ª—å—Å
    const wob = Math.sin((t - State.foodWobbleT) / 180) * 1.2;
    const pulse = 1 + Math.sin((t - State.foodWobbleT) / 240) * 0.05;

    const x = cellToPx(State.food.x) + 2 + wob;
    const y = cellToPx(State.food.y) + 18 - wob;

    ctx.save();
    ctx.translate(x + 8, y - 10);
    ctx.scale(pulse, pulse);
    ctx.translate(-(x + 8), -(y - 10));

    ctx.font = "18px serif";
    ctx.textBaseline = "alphabetic";
    ctx.shadowColor = "rgba(0,0,0,0.35)";
    ctx.shadowBlur = 6;
    ctx.fillText(State.food.icon, x, y);
    ctx.restore();
  };

  const drawPop = (t) => {
    if (!State.pop) return;
    const { x, y, t: t0, dur } = State.pop;
    const p = (t - t0) / dur;
    if (p >= 1) { State.pop = null; return; }

    const cx = cellToPx(x) + BOX / 2;
    const cy = cellToPx(y) + BOX / 2;

    const accent = getComputedStyle(document.body).getPropertyValue("--accent").trim();
    ctx.strokeStyle = accent;
    ctx.lineWidth = 2;
    ctx.globalAlpha = 1 - p;

    const r = 4 + p * 12;
    ctx.beginPath();
    ctx.arc(cx, cy, r, 0, Math.PI * 2);
    ctx.stroke();

    // tiny sparkles
    ctx.fillStyle = accent;
    for (let i = 0; i < 8; i++) {
      const a = (i / 8) * Math.PI * 2;
      const rr = 6 + p * 14;
      const sx = Math.round(cx + Math.cos(a) * rr);
      const sy = Math.round(cy + Math.sin(a) * rr);
      ctx.fillRect(sx, sy, 2, 2);
    }

    ctx.globalAlpha = 1;
  };

  const drawHeadFace = (cx, cy, scale = 1, chomp = 0) => {
    // Eyes
    const dx = State.dir.x, dy = State.dir.y;
    const lookX = dx * 4, lookY = dy * 4;

    const eyeY = -4 * scale;
    const eyeX = 4 * scale;

    ctx.fillStyle = "rgba(255,255,255,0.95)";
    ctx.beginPath();
    ctx.arc(cx - eyeX + lookX, cy + eyeY + lookY, 2.2 * scale, 0, Math.PI * 2);
    ctx.arc(cx + eyeX + lookX, cy + eyeY + lookY, 2.2 * scale, 0, Math.PI * 2);
    ctx.fill();

    ctx.fillStyle = "rgba(0,0,0,0.82)";
    ctx.beginPath();
    ctx.arc(cx - eyeX + lookX, cy + eyeY + lookY, 1.1 * scale, 0, Math.PI * 2);
    ctx.arc(cx + eyeX + lookX, cy + eyeY + lookY, 1.1 * scale, 0, Math.PI * 2);
    ctx.fill();

    // Mouth (–æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ chomp)
    const mx = cx + dx * 5;
    const my = cy + dy * 5 + 4;
    const w = 8 * scale;
    const open = Math.max(1, Math.round(chomp * 5)); // 1..5
    ctx.fillStyle = "rgba(0,0,0,0.55)";
    ctx.fillRect(Math.round(mx - w/2), Math.round(my), Math.round(w), open);

    // Tiny tooth highlight
    if (chomp > 0.15) {
      ctx.fillStyle = "rgba(255,255,255,0.70)";
      ctx.fillRect(Math.round(mx - 2), Math.round(my), 2, 1);
      ctx.fillRect(Math.round(mx + 1), Math.round(my), 2, 1);
    }
  };

  const drawSnake = (t) => {
    const head = State.snake[0];
    if (!head) return;

    let headScale = 1;
    let chomp = 0;

    if (State.chomp) {
      const p = (t - State.chomp.t) / State.chomp.dur;
      if (p >= 1) {
        State.chomp = null;
      } else {
        const bump = Math.sin(p * Math.PI);
        headScale = 1 + bump * 0.12;
        chomp = bump;
      }
    }

    const headColor = "rgba(255,209,225,0.96)";
    const bodyColor = "rgba(255,107,154,0.92)";

    for (let i = 0; i < State.snake.length; i++) {
      const s = State.snake[i];
      const x = cellToPx(s.x) + 1;
      const y = cellToPx(s.y) + 1;
      const w = BOX - 2;
      const h = BOX - 2;

      if (i === 0) {
        const cx = x + w / 2;
        const cy = y + h / 2;
        const sw = w * headScale;
        const sh = h * headScale;

        const rx = Math.round(cx - sw / 2);
        const ry = Math.round(cy - sh / 2);
        const rw = Math.round(sw);
        const rh = Math.round(sh);

        // Head base
        ctx.fillStyle = headColor;
        ctx.fillRect(rx, ry, rw, rh);

        // Head highlight
        ctx.fillStyle = "rgba(255,255,255,0.14)";
        ctx.fillRect(rx + 2, ry + 2, Math.max(0, rw - 6), 2);

        // Face
        drawHeadFace(cx, cy, headScale, chomp);
      } else {
        ctx.fillStyle = bodyColor;
        ctx.fillRect(x, y, w, h);

        // subtle body highlight
        ctx.fillStyle = "rgba(255,255,255,0.10)";
        ctx.fillRect(x + 2, y + 2, Math.max(0, w - 6), 1);
      }
    }
  };

  const drawDeath = (t) => {
    if (!State.death) return;
    const { t: t0, dur, particles } = State.death;
    const p = (t - t0) / dur;

    const accent = getComputedStyle(document.body).getPropertyValue("--accent").trim();
    ctx.fillStyle = accent;

    for (const pt of particles) {
      pt.x += pt.vx;
      pt.y += pt.vy;
      pt.vy += 0.06;
      pt.life = 1 - p;
      if (pt.life > 0.15 || Math.random() > 0.4) {
        ctx.globalAlpha = Math.max(0, pt.life);
        ctx.fillRect(Math.round(pt.x), Math.round(pt.y), pt.size, pt.size);
      }
    }
    ctx.globalAlpha = 1;

    if (p >= 1) {
      State.death = null;
      endGame();
    }
  };

  const render = (t) => {
    // background fill (keeps it crisp)
    const canvasBg = getComputedStyle(document.body).getPropertyValue("--canvas").trim();
    ctx.fillStyle = canvasBg;
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    drawGrid();

    if (State.mode === "dying") {
      drawDeath(t);
    } else {
      if (State.mode !== "start") drawFood(t);
      drawPop(t);
      drawSnake(t);
    }

    requestAnimationFrame(render);
  };

  // Main loop
  let lastTick = now();
  const loop = () => {
    const t = now();
    if (t - lastTick >= TICK_MS) {
      lastTick = t;
      tick();
    }
    requestAnimationFrame(loop);
  };

  // Controls buttons
  const bindButton = (selector, x, y) => {
    const el = document.querySelector(selector);
    el.onpointerdown = () => setDir(x, y);
  };
  bindButton(".up", 0, -1);
  bindButton(".down", 0, 1);
  bindButton(".left", -1, 0);
  bindButton(".right", 1, 0);

  // Keyboard
  document.addEventListener("keydown", (e) => {
    const k = e.key;
    if (k === "ArrowUp" || k === "w" || k === "W") setDir(0, -1);
    if (k === "ArrowDown" || k === "s" || k === "S") setDir(0, 1);
    if (k === "ArrowLeft" || k === "a" || k === "A") setDir(-1, 0);
    if (k === "ArrowRight" || k === "d" || k === "D") setDir(1, 0);

    if (k === "Escape" || k === " " || k === "Enter") {
      if (State.mode === "playing") openPauseMenu();
      else if (State.mode === "paused") resumeGame();
    }
  });

  // Swipe
  let sx = 0, sy = 0;
  canvas.addEventListener("pointerdown", (e) => { sx = e.clientX; sy = e.clientY; });
  canvas.addEventListener("pointerup", (e) => {
    const dx = e.clientX - sx;
    const dy = e.clientY - sy;
    if (Math.abs(dx) < 18 && Math.abs(dy) < 18) return;
    if (Math.abs(dx) > Math.abs(dy)) setDir(dx > 0 ? 1 : -1, 0);
    else setDir(0, dy > 0 ? 1 : -1);
  });

  // UI actions
  UI.theme.onpointerdown = () => {
    document.body.classList.toggle("light");
    beep(520, 0.06);
  };

  UI.sound.onpointerdown = async () => {
    await initAudio();
    soundOn = !soundOn;
    localStorage.setItem("malorisa_sound", soundOn ? "1" : "0");
    UI.sound.textContent = soundOn ? "üîä" : "üîá";
    beep(520, 0.08);
  };

  UI.pause.onpointerdown = () => {
    if (State.mode === "playing") openPauseMenu();
    else if (State.mode === "paused") resumeGame();
  };

  UI.resume.onpointerdown = () => resumeGame();
  UI.toMenu.onpointerdown = () => goToMenu();

  UI.invite.onpointerdown = () => shareGame();
  const SITE_URL = "https://malorisa.ru";
  UI.site.onpointerdown = () => window.open(SITE_URL, "_blank");

  UI.saveNick.onpointerdown = async () => { await registerNick(); };
  UI.nick.addEventListener("keydown", async (e) => { if (e.key === "Enter") await registerNick(); });

  const canPlay = () => {
    const { player_id, name } = getSavedPlayer();
    return Boolean(player_id && name);
  };

  UI.play.onpointerdown = async () => {
    if (!canPlay()) {
      setNickStatus("–°–Ω–∞—á–∞–ª–∞ –∑–∞–∫—Ä–µ–ø–∏ —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –Ω–∏–∫ (–Ω–∞–∂–º–∏ OK)", "err");
      return;
    }
    await initAudio();
    beep(440, 0.14);
    hideAllOverlays();
    startGame();
  };

  UI.restart.onpointerdown = async () => {
    if (!canPlay()) {
      goToMenu();
      setNickStatus("–°–Ω–∞—á–∞–ª–∞ –∑–∞–∫—Ä–µ–ø–∏ —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –Ω–∏–∫ (–Ω–∞–∂–º–∏ OK)", "err");
      return;
    }
    await initAudio();
    beep(440, 0.14);
    hideAllOverlays();
    startGame();
  };

  UI.menuFromOver.onpointerdown = () => goToMenu();

  // Init UI
  ensureNickRegisteredUI();
  loadLeaderboard();

  // Start loops
  requestAnimationFrame(render);
  requestAnimationFrame(loop);
})();
</script>

</body>
</html>

